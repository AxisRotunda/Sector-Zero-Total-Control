<div class="absolute z-50 flex flex-col pointer-events-auto animate-in fade-in transition-all duration-300
            md:inset-0 md:bg-black/80 md:backdrop-blur-sm md:flex-col
            inset-x-0 bottom-0 h-[75vh] md:h-full shadow-2xl md:shadow-none" 
     (touchstart)="$event.stopPropagation()">
    
    <!-- HEADER -->
    <div class="p-3 border-b border-zinc-800 bg-zinc-900/95 shrink-0 flex justify-between items-center relative">
        <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-12 h-1 bg-zinc-600 rounded-full md:hidden"></div>
        <div class="flex items-center gap-4">
            <div class="flex flex-col">
                <h2 class="text-lg md:text-xl font-bold text-zinc-100 tracking-tighter flex items-center gap-2">
                    <span class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></span> FIELD KIT
                </h2>
                <span class="text-[9px] text-zinc-500 tracking-widest uppercase hidden md:block">Unit Configuration // ID: 7421-A</span>
            </div>
            
            <div class="flex items-center gap-3 px-3 py-1 bg-black rounded border border-zinc-800">
                <div class="flex flex-col items-end">
                    <span class="text-[8px] text-zinc-500 font-bold uppercase">CREDITS</span>
                    <span class="text-[10px] text-yellow-500 font-mono">{{player.progression.credits()}}</span>
                </div>
                <div class="w-px h-6 bg-zinc-800"></div>
                <div class="flex flex-col items-end">
                    <span class="text-[8px] text-zinc-500 font-bold uppercase">SCRAP</span>
                    <span class="text-[10px] text-zinc-300 font-mono">{{player.progression.scrap()}}</span>
                </div>
            </div>
        </div>

        <div class="flex gap-2">
            <button (click)="toggleCrafting()" 
                    class="px-4 py-2 text-[10px] md:text-xs font-bold border rounded-sm transition-colors uppercase tracking-wider"
                    [class]="showCrafting() ? 'bg-orange-900/50 border-orange-500 text-orange-200' : 'bg-zinc-800 border-zinc-600 text-zinc-400 hover:text-white'">
                {{ showCrafting() ? 'CLOSE FORGE' : 'NANO-FORGE' }}
            </button>
            <button (click)="close.emit()" class="px-4 py-2 bg-zinc-800 active:bg-zinc-700 text-zinc-300 text-[10px] md:text-xs font-bold border border-zinc-600 rounded-sm hover:text-white hover:border-orange-500 transition-colors">CLOSE</button>
        </div>
    </div>
    
    <!-- MAIN CONTENT -->
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative bg-zinc-950/90 md:bg-transparent">
        
        <!-- CRAFTING PANEL -->
        @if (showCrafting()) {
            <div class="w-full md:w-80 shrink-0 p-0 border-b md:border-b-0 md:border-r border-zinc-800 bg-zinc-900/95 flex flex-col animate-in slide-in-from-left-4 z-20 absolute md:static inset-0 md:inset-auto h-full">
                
                <!-- Crafting Tabs -->
                <div class="flex border-b border-zinc-800 shrink-0">
                    <button (click)="setCraftMode('TUNE')" 
                            class="flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition-colors relative"
                            [class]="craftMode() === 'TUNE' ? 'bg-zinc-800 text-cyan-400' : 'text-zinc-500 hover:text-zinc-300'">
                        Tuning
                        @if(craftMode() === 'TUNE') { <div class="absolute bottom-0 left-0 w-full h-0.5 bg-cyan-500"></div> }
                    </button>
                    <button (click)="setCraftMode('AUGMENT')" 
                            class="flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition-colors relative"
                            [class]="craftMode() === 'AUGMENT' ? 'bg-zinc-800 text-purple-400' : 'text-zinc-500 hover:text-zinc-300'">
                        Augment
                        @if(craftMode() === 'AUGMENT') { <div class="absolute bottom-0 left-0 w-full h-0.5 bg-purple-500"></div> }
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-4 flex flex-col gap-4">
                    @if (selectedCraftItem(); as item) {
                        <!-- Selected Item Header -->
                        <div class="flex flex-col items-center gap-2 p-4 bg-black/40 border border-zinc-800 rounded">
                            <div class="w-16 h-16 border border-zinc-600 p-1 relative">
                                <app-item-icon [item]="item"></app-item-icon>
                                <div class="absolute top-0 right-0 w-full h-full border-2 opacity-50" [style.border-color]="item.color"></div>
                            </div>
                            <div class="text-center">
                                <div class="text-sm font-bold text-white">{{item.name}}</div>
                                <div class="text-[9px] text-zinc-400 font-mono">Level {{item.level}} {{item.rarity}}</div>
                            </div>
                        </div>

                        @if (craftMode() === 'TUNE') {
                            <div class="flex flex-col gap-3">
                                <button (click)="doReroll()" 
                                        [disabled]="!crafting.canReroll(item)"
                                        class="w-full p-4 bg-zinc-800 border border-zinc-600 hover:border-cyan-500 flex flex-col items-center gap-1 group disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                                    <span class="text-xs font-bold text-cyan-400 group-hover:text-cyan-200">RE-INITIALIZE</span>
                                    <span class="text-[9px] text-zinc-500 uppercase tracking-wide">Reroll Stats // 50 Scrap</span>
                                </button>

                                <button (click)="doUpgrade()" 
                                        [disabled]="!crafting.canUpgrade(item)"
                                        class="w-full p-4 bg-zinc-800 border border-zinc-600 hover:border-green-500 flex flex-col items-center gap-1 group disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                                    <span class="text-xs font-bold text-green-400 group-hover:text-green-200">OPTIMIZE</span>
                                    <span class="text-[9px] text-zinc-500 uppercase tracking-wide">Level Up // 100 Scrap</span>
                                </button>
                            </div>
                        }

                        @if (craftMode() === 'AUGMENT') {
                            @let augments = getValidAugments(item);
                            
                            <div class="text-[9px] text-zinc-500 uppercase tracking-widest font-bold text-center border-b border-zinc-800 pb-2">Available Modules</div>
                            
                            <div class="flex flex-col gap-2">
                                @for (aug of augments; track aug.stat) {
                                    <button (click)="doAugment(aug)"
                                            [disabled]="!crafting.canAugment(item, aug)"
                                            class="flex justify-between items-center p-3 bg-zinc-800/50 border border-zinc-700 hover:border-purple-500 hover:bg-purple-900/10 transition-all group disabled:opacity-50">
                                        <div class="flex flex-col items-start">
                                            <span class="text-xs font-bold text-zinc-300 group-hover:text-purple-200">{{aug.label}}</span>
                                            <span class="text-[9px] text-purple-400 font-mono">+{{aug.value}} {{aug.stat | uppercase}}</span>
                                        </div>
                                        <span class="text-[10px] font-mono font-bold" [class]="player.progression.scrap() >= aug.cost ? 'text-zinc-400' : 'text-red-500'">{{aug.cost}} S</span>
                                    </button>
                                }
                                @if (augments.length === 0) {
                                    <div class="p-4 text-center text-[10px] text-zinc-600 italic border border-dashed border-zinc-800">
                                        NO COMPATIBLE SLOTS
                                    </div>
                                }
                            </div>
                        }

                    } @else {
                        <div class="flex-1 flex flex-col items-center justify-center text-zinc-600 text-xs italic text-center p-8 border-2 border-dashed border-zinc-800 rounded m-4">
                            AWAITING INPUT... <br> SELECT ITEM
                        </div>
                    }
                </div>
            </div>
        }

        <!-- EQUIPMENT -->
        <div class="flex flex-col gap-2 w-full md:w-64 shrink-0 p-3 border-b md:border-b-0 md:border-r border-zinc-800 overflow-y-auto bg-black/40 md:bg-zinc-950/60"
             [class.hidden]="showCrafting() && (Math.max(window.innerWidth) < 768)"> 
            
            <h3 class="text-[9px] font-bold text-orange-500 tracking-widest uppercase border-b border-zinc-800/50 pb-1 mb-1">Equipped Hardware</h3>
            
            <div class="grid grid-cols-3 md:grid-cols-2 gap-2">
                @for (slot of equipmentSlots; track slot) {
                    @let item = inventory.equipped()[$any(slot)];
                    <div class="flex flex-col gap-1">
                        <span class="text-[8px] text-zinc-500 uppercase font-bold text-center truncate">{{slot}}</span>
                        
                        <div #equipSlot
                             class="aspect-square bg-black/60 border border-zinc-800 rounded-sm transition-colors duration-200 relative group"
                             [attr.data-slot-type]="'equipment'"
                             [attr.data-slot-name]="slot"
                             [class.border-orange-500/50]="dragOverSlot()?.type === 'equipment' && dragOverSlot()?.slot === slot"
                             [class.bg-orange-900/20]="dragOverSlot()?.type === 'equipment' && dragOverSlot()?.slot === slot"
                             (dragover)="onDragOver($event, 'equipment', undefined, slot)"
                             (dragleave)="onDragLeave()"
                             (drop)="onDrop($event, 'equipment', undefined, slot)">
                            
                            @if (item) {
                                <div class="w-full h-full p-1.5 cursor-grab active:cursor-grabbing touch-none relative"
                                     draggable="true"
                                     (click)="selectForCrafting(item)"
                                     (dragstart)="onDragStart($event, { item: item, from: 'equipment', fromSlot: slot })"
                                     (dragend)="onDragEnd()"
                                     (touchstart)="onTouchStart($event, { item: item, from: 'equipment', fromSlot: slot })"
                                     (touchmove)="onTouchMove($event)"
                                     (touchend)="onTouchEnd($event, { item: item, from: 'equipment', fromSlot: slot })"
                                     (mouseover)="onMouseOver($event, item)"
                                     (mouseout)="onMouseOut()">
                                    <app-item-icon [item]="item"></app-item-icon>
                                </div>
                                <div class="absolute bottom-0 right-0.5 text-[8px] font-mono text-zinc-500 pointer-events-none bg-black/50 px-0.5">L{{item.level}}</div>
                            } @else {
                                <div class="w-full h-full flex items-center justify-center opacity-10">
                                    <div class="w-1.5 h-1.5 rounded-full bg-zinc-500"></div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
            
            <div class="bg-zinc-900/40 p-2 md:p-4 border border-zinc-800 rounded-sm mt-1 md:mt-auto hidden md:block">
               <h3 class="text-[9px] font-bold text-zinc-500 mb-1 md:mb-2 tracking-widest uppercase border-b border-zinc-800/50 pb-1">Analytics</h3>
               <div class="grid grid-cols-4 md:grid-cols-2 gap-x-2 gap-y-1 text-[10px] md:text-xs font-mono">
                   <div class="text-zinc-500">DMG</div> <div class="text-right text-orange-400 font-bold">{{Math.floor(player.stats.playerStats().damage)}}</div>
                   <div class="text-zinc-500">HP</div> <div class="text-right text-red-400 font-bold">{{Math.floor(player.stats.playerStats().hpMax)}}</div>
               </div>
            </div>
        </div>

        <!-- BAG -->
        <div class="flex-1 flex flex-col bg-zinc-900/20 p-3 overflow-hidden relative shadow-inner">
            <div class="flex justify-between items-end mb-2 px-1">
                <h3 class="text-[9px] font-bold text-zinc-500 tracking-widest uppercase">Storage</h3>
                <div class="text-[9px] text-zinc-600 font-mono">{{inventory.bag().length}} / {{inventory.bagSize}}</div>
            </div>
            
            <div class="grid grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-2 overflow-y-auto content-start flex-1 pb-20 touch-pan-y custom-scrollbar">
                @for (item of inventory.bag(); track item.id; let i = $index) {
                    <div #bagSlot
                         class="aspect-square bg-zinc-950/80 border border-zinc-800 flex flex-col p-1 relative transition-all duration-200 group shadow-sm rounded-sm"
                         [attr.data-slot-type]="'bag'"
                         [attr.data-index]="i"
                         [class.border-cyan-500]="selectedCraftItem()?.id === item.id"
                         [class.ring-2]="selectedCraftItem()?.id === item.id"
                         [class.ring-cyan-500]="selectedCraftItem()?.id === item.id"
                         [class.border-orange-500/50]="dragOverSlot()?.type === 'bag' && dragOverSlot()?.index === i"
                         [class.bg-orange-900/20]="dragOverSlot()?.type === 'bag' && dragOverSlot()?.index === i"
                         [class.opacity-30]="draggedItem()?.item?.id === item.id"
                         (click)="selectForCrafting(item)"
                         (dragover)="onDragOver($event, 'bag', i)"
                         (dragleave)="onDragLeave()"
                         (drop)="onDrop($event, 'bag', i)">
                        
                        <div class="absolute top-0 left-0 w-full h-0.5" [style.background-color]="item.color"></div>
                        
                        <div class="w-full h-full cursor-grab active:cursor-grabbing touch-none relative"
                             draggable="true"
                             (dragstart)="onDragStart($event, { item: item, from: 'bag', fromIndex: i })"
                             (dragend)="onDragEnd()"
                             (touchstart)="onTouchStart($event, { item: item, from: 'bag', fromIndex: i })"
                             (touchmove)="onTouchMove($event)"
                             (touchend)="onTouchEnd($event, { item: item, from: 'bag', fromIndex: i })"
                             (mouseover)="onMouseOver($event, item)"
                             (mouseout)="onMouseOut()">
                            <app-item-icon [item]="item"></app-item-icon>
                        </div>

                        @if (item.stack > 1) {
                            <div class="absolute bottom-0 right-0 text-[9px] font-mono font-bold text-white bg-black/80 px-1 border-t border-l border-zinc-800">{{item.stack}}</div>
                        }
                    </div>
                }
                
                @for (i of [].constructor(inventory.bagSize - inventory.bag().length); track i) {
                    @let actualIndex = inventory.bag().length + i;
                    <div #bagSlot
                         class="aspect-square bg-zinc-950/40 border border-zinc-800/50 rounded-sm transition-colors duration-200"
                         [attr.data-slot-type]="'bag'"
                         [attr.data-index]="actualIndex"
                         [class.border-orange-500/50]="dragOverSlot()?.type === 'bag' && dragOverSlot()?.index === actualIndex"
                         [class.bg-orange-900/20]="dragOverSlot()?.type === 'bag' && dragOverSlot()?.index === actualIndex"
                         (dragover)="onDragOver($event, 'bag', actualIndex)"
                         (dragleave)="onDragLeave()"
                         (drop)="onDrop($event, 'bag', actualIndex)">
                    </div>
                }
            </div>
        </div>
    </div>

    @if (isTouchDragging() && draggedItem(); as drag) {
        <div class="fixed w-16 h-16 pointer-events-none z-[100] opacity-90 filter drop-shadow-[0_0_10px_rgba(255,255,255,0.2)]"
             [style.left.px]="ghostPos().x - 32"
             [style.top.px]="ghostPos().y - 32">
             <div class="w-full h-full p-2 bg-zinc-900 border border-zinc-400 rounded-lg">
                <app-item-icon [item]="drag.item"></app-item-icon>
             </div>
        </div>
    }
</div>